<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì S∆° C√° Nh√¢n - Learning System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .profile-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #f0f2f5;
        }

        .avatar-section {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #007bff;
            background: #f8f9fa;
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .form-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .form-section h3 {
            margin-bottom: 1rem;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }

        .bio-section {
            grid-column: 1 / -1;
        }

        .skills-section {
            grid-column: 1 / -1;
        }

        .skill-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        .skill-item input, .skill-item select {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .remove-skill {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 0.8rem;
            cursor: pointer;
        }

        .add-skill-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
        }

        .social-links {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .save-btn {
            grid-column: 1 / -1;
            background: #007bff;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 2rem;
        }

        .save-btn:hover {
            background: #0056b3;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .profile-form {
                grid-template-columns: 1fr;
            }
            
            .social-links {
                grid-template-columns: 1fr;
            }
            
            .skill-item {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <a href="/">Learning System</a>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="/" class="nav-link">Trang ch·ªß</a>
                    </li>
                    <li class="nav-item">
                        <a href="/profile.html" class="nav-link active">H·ªì s∆°</a>
                    </li>
                    <li class="nav-item">
                        <a href="/auth.html" class="nav-link" id="authLink">ƒêƒÉng nh·∫≠p</a>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <div class="profile-container">
            <div class="alert" id="alertMessage"></div>
            
            <div class="profile-header">
                <div class="avatar-section">
                    <img id="avatarPreview" class="avatar" src="/uploads/images/default-avatar.png" alt="Avatar">
                    <button type="button" class="avatar-upload" onclick="document.getElementById('avatarInput').click()">
                        üì∑
                    </button>
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(this)">
                </div>
                <h1 id="userName">T√™n ng∆∞·ªùi d√πng</h1>
                <p id="userEmail">email@example.com</p>
            </div>

            <form id="profileForm" class="profile-form">
                <!-- Th√¥ng tin c∆° b·∫£n -->
                <div class="form-section">
                    <h3>Th√¥ng tin c∆° b·∫£n</h3>
                    <div class="form-group">
                        <label for="name">H·ªç v√† t√™n</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                    <div class="form-group">
                        <label for="age">Tu·ªïi</label>
                        <input type="number" id="age" name="age" min="1" max="120">
                    </div>
                </div>

                <!-- ƒê·ªãa ch·ªâ -->
                <div class="form-section">
                    <h3>ƒê·ªãa ch·ªâ</h3>
                    <div class="form-group">
                        <label for="street">ƒê·ªãa ch·ªâ</label>
                        <input type="text" id="street" name="street">
                    </div>
                    <div class="form-group">
                        <label for="city">Th√†nh ph·ªë</label>
                        <input type="text" id="city" name="city">
                    </div>
                    <div class="form-group">
                        <label for="country">Qu·ªëc gia</label>
                        <input type="text" id="country" name="country">
                    </div>
                </div>

                <!-- Bio -->
                <div class="form-section bio-section">
                    <h3>Gi·ªõi thi·ªáu b·∫£n th√¢n</h3>
                    <div class="form-group">
                        <label for="bio">M√¥ t·∫£ v·ªÅ b·∫°n (t·ªëi ƒëa 500 k√Ω t·ª±)</label>
                        <textarea id="bio" name="bio" maxlength="500" placeholder="H√£y k·ªÉ v·ªÅ b·∫£n th√¢n, s·ªü th√≠ch, m·ª•c ti√™u h·ªçc t·∫≠p..."></textarea>
                        <small id="bioCount">0/500 k√Ω t·ª±</small>
                    </div>
                </div>

                <!-- K·ªπ nƒÉng -->
                <div class="form-section skills-section">
                    <h3>K·ªπ nƒÉng</h3>
                    <div id="skillsList">
                        <!-- Skills will be dynamically added here -->
                    </div>
                    <button type="button" class="add-skill-btn" onclick="addSkill()">+ Th√™m k·ªπ nƒÉng</button>
                </div>

                <!-- Social Links -->
                <div class="form-section">
                    <h3>Li√™n k·∫øt m·∫°ng x√£ h·ªôi</h3>
                    <div class="social-links">
                        <div class="form-group">
                            <label for="website">Website</label>
                            <input type="url" id="website" name="website" placeholder="https://yourwebsite.com">
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                        </div>
                        <div class="form-group">
                            <label for="github">GitHub</label>
                            <input type="url" id="github" name="github" placeholder="https://github.com/yourusername">
                        </div>
                        <div class="form-group">
                            <label for="twitter">Twitter</label>
                            <input type="url" id="twitter" name="twitter" placeholder="https://twitter.com/yourusername">
                        </div>
                    </div>
                </div>

                <button type="submit" class="save-btn">üíæ L∆∞u thay ƒë·ªïi</button>
            </form>
        </div>
    </main>

    <script src="js/auth.js"></script>
    <script>
        let currentUser = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserProfile();
            updateNavigation();
            setupEventListeners();
        });

        // Load user profile data
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = '/auth.html';
                    return;
                }

                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load profile');
                }

                const data = await response.json();
                currentUser = data.data.user;
                populateForm();
            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h·ªì s∆°', 'error');
            }
        }

        // Populate form with user data
        function populateForm() {
            if (!currentUser) return;

            // Basic info
            document.getElementById('userName').textContent = currentUser.name || 'T√™n ng∆∞·ªùi d√πng';
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('name').value = currentUser.name || '';
            document.getElementById('email').value = currentUser.email || '';
            document.getElementById('phone').value = currentUser.phone || '';
            document.getElementById('age').value = currentUser.age || '';

            // Avatar
            if (currentUser.avatar) {
                document.getElementById('avatarPreview').src = currentUser.avatar;
            }

            // Address
            if (currentUser.address) {
                document.getElementById('street').value = currentUser.address.street || '';
                document.getElementById('city').value = currentUser.address.city || '';
                document.getElementById('country').value = currentUser.address.country || '';
            }

            // Bio
            document.getElementById('bio').value = currentUser.bio || '';
            updateBioCount();

            // Skills
            if (currentUser.skills && currentUser.skills.length > 0) {
                currentUser.skills.forEach(skill => {
                    addSkill(skill);
                });
            } else {
                addSkill(); // Add empty skill if no skills exist
            }

            // Social links
            if (currentUser.socialLinks) {
                document.getElementById('website').value = currentUser.socialLinks.website || '';
                document.getElementById('linkedin').value = currentUser.socialLinks.linkedin || '';
                document.getElementById('github').value = currentUser.socialLinks.github || '';
                document.getElementById('twitter').value = currentUser.socialLinks.twitter || '';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Bio character count
            document.getElementById('bio').addEventListener('input', updateBioCount);

            // Form submission
            document.getElementById('profileForm').addEventListener('submit', handleFormSubmit);
        }

        // Update bio character count
        function updateBioCount() {
            const bio = document.getElementById('bio');
            const count = bio.value.length;
            document.getElementById('bioCount').textContent = `${count}/500 k√Ω t·ª±`;
        }

        // Preview avatar
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Add skill
        function addSkill(skill = null) {
            const skillsList = document.getElementById('skillsList');
            const skillDiv = document.createElement('div');
            skillDiv.className = 'skill-item';
            
            skillDiv.innerHTML = `
                <input type="text" placeholder="T√™n k·ªπ nƒÉng" value="${skill?.name || ''}" class="skill-name">
                <select class="skill-level">
                    <option value="Beginner" ${skill?.level === 'Beginner' ? 'selected' : ''}>M·ªõi b·∫Øt ƒë·∫ßu</option>
                    <option value="Intermediate" ${skill?.level === 'Intermediate' ? 'selected' : ''}>Trung b√¨nh</option>
                    <option value="Advanced" ${skill?.level === 'Advanced' ? 'selected' : ''}>N√¢ng cao</option>
                    <option value="Expert" ${skill?.level === 'Expert' ? 'selected' : ''}>Chuy√™n gia</option>
                </select>
                <input type="number" placeholder="NƒÉm kinh nghi·ªám" min="0" max="50" value="${skill?.yearsOfExperience || 0}" class="skill-years">
                <button type="button" class="remove-skill" onclick="removeSkill(this)">üóëÔ∏è</button>
            `;
            
            skillsList.appendChild(skillDiv);
        }

        // Remove skill
        function removeSkill(button) {
            button.parentElement.remove();
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData();
                
                // Basic info
                formData.append('name', document.getElementById('name').value);
                formData.append('email', document.getElementById('email').value);
                formData.append('phone', document.getElementById('phone').value);
                formData.append('age', document.getElementById('age').value);
                formData.append('bio', document.getElementById('bio').value);

                // Address
                const address = {
                    street: document.getElementById('street').value,
                    city: document.getElementById('city').value,
                    country: document.getElementById('country').value
                };
                formData.append('address', JSON.stringify(address));

                // Skills
                const skills = [];
                document.querySelectorAll('.skill-item').forEach(item => {
                    const name = item.querySelector('.skill-name').value.trim();
                    if (name) {
                        skills.push({
                            name: name,
                            level: item.querySelector('.skill-level').value,
                            yearsOfExperience: parseInt(item.querySelector('.skill-years').value) || 0
                        });
                    }
                });
                formData.append('skills', JSON.stringify(skills));

                // Social links
                const socialLinks = {
                    website: document.getElementById('website').value,
                    linkedin: document.getElementById('linkedin').value,
                    github: document.getElementById('github').value,
                    twitter: document.getElementById('twitter').value
                };
                formData.append('socialLinks', JSON.stringify(socialLinks));

                // Avatar file
                const avatarInput = document.getElementById('avatarInput');
                if (avatarInput.files[0]) {
                    formData.append('avatar', avatarInput.files[0]);
                }

                const token = localStorage.getItem('token');
                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showAlert('C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!', 'success');
                    currentUser = data.data.user;
                    populateForm(); // Refresh form with updated data
                } else {
                    throw new Error(data.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t h·ªì s∆°: ' + error.message, 'error');
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            alert.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>